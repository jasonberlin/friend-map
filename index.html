<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friend Map</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üó∫Ô∏è</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 28px;
            color: #2563eb;
        }
        
        .stats {
            margin-top: 10px;
            color: #666;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }
        
        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1d4ed8;
        }
        
        .btn-success {
            background: #16a34a;
            color: white;
        }
        
        .btn-success:hover {
            background: #15803d;
        }
        
        .btn-purple {
            background: #9333ea;
            color: white;
        }
        
        .btn-purple:hover {
            background: #7c3aed;
        }
        
        .btn-cancel {
            background: #e5e7eb;
            color: #333;
        }
        
        .btn-cancel:hover {
            background: #d1d5db;
        }
        
        .search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .friends-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
        }
        
        .friend-item {
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .friend-item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }
        
        .friend-info {
            flex: 1;
        }
        
        .friend-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .friend-location {
            font-size: 12px;
            color: #666;
        }
        
        .friend-actions {
            display: flex;
            gap: 8px;
        }
        
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .icon-btn:hover {
            opacity: 1;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .map-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 600px;
            position: relative;
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .map-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
        }
        
        .instructions {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .instructions h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #1e40af;
        }
        
        .instructions ol {
            font-size: 13px;
            color: #2563eb;
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }
        
        .warning {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            color: #92400e;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .progress-bar {
            background: #e0f2fe;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 500;
            color: #0369a1;
        }
        
        .progress-track {
            background: #bae6fd;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: #0284c7;
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .progress-stats {
            margin-top: 8px;
            font-size: 12px;
            color: #0c4a6e;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .modal h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            flex: 1;
        }
        
        .stats-panel {
            background: #f9fafb;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
            font-size: 13px;
            display: none;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
        }
        
        .stat-value {
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .map-container {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>üìç</span>
                <span>Friend Map</span>
            </h1>
            <div class="stats">
                <span id="friendCount">üë• 0 friends</span>
                <span id="mapStatus" style="margin-left: 20px;"></span>
            </div>
        </div>
        
        <div class="main-grid">
            <div class="sidebar">
                <h2 style="margin-bottom: 15px; font-size: 18px;">Your Friends</h2>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="showAddModal()">+ Add</button>
                    <button class="btn btn-success" onclick="triggerImport()">‚Üë Import</button>
                    <button class="btn btn-purple" onclick="exportData()">‚Üì Export</button>
                </div>
                
                <input type="file" id="fileInput" accept=".vcf,.json" style="display: none;">
                
                <input type="text" class="search-box" id="searchInput" placeholder="Search friends...">
                
                <div class="progress-bar" id="progressBar">
                    <div class="progress-header">
                        <span>Importing contacts...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-stats" id="progressStats"></div>
                </div>
                
                <div class="friends-list" id="friendsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <div>No friends added yet</div>
                        <div style="font-size: 13px; margin-top: 8px;">Add your first friend or import contacts!</div>
                    </div>
                </div>
                
                <div class="stats-panel" id="statsPanel">
                    <div class="stat-row">
                        <span class="stat-label">Total:</span>
                        <span class="stat-value" id="totalStat">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Geocoded:</span>
                        <span class="stat-value" id="geocodedStat" style="color: #16a34a;">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Pending:</span>
                        <span class="stat-value" id="pendingStat" style="color: #eab308;">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Failed:</span>
                        <span class="stat-value" id="failedStat" style="color: #dc2626;">0</span>
                    </div>
                </div>
                
                <div class="instructions">
                    <h3>üì± Import Apple Contacts</h3>
                    <ol>
                        <li>Go to icloud.com ‚Üí Sign in</li>
                        <li>Open Contacts ‚Üí Select All (Cmd+A)</li>
                        <li>Settings gear ‚Üí Export vCard</li>
                        <li>Upload the .vcf file here</li>
                    </ol>
                    <div class="warning">
                        ‚ö° Large imports processed in batches to avoid API limits
                    </div>
                </div>
            </div>
            
            <div class="map-container">
                <div id="map">
                    <div class="map-placeholder">
                        <div>
                            <div style="font-size: 64px; margin-bottom: 20px;">üó∫Ô∏è</div>
                            <h2>Loading Google Maps...</h2>
                            <p style="margin-top: 10px; opacity: 0.9;">Initializing with API key</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="addModal">
        <div class="modal-content">
            <h2>Add New Friend</h2>
            <form id="addForm" onsubmit="addFriend(event)">
                <div class="form-group">
                    <input type="text" id="friendName" placeholder="Name *" required>
                </div>
                <div class="form-group">
                    <input type="text" id="friendAddress" placeholder="Street Address">
                </div>
                <div class="form-group form-row">
                    <input type="text" id="friendCity" placeholder="City *" required>
                    <input type="text" id="friendState" placeholder="State *" required>
                </div>
                <div class="form-group">
                    <input type="text" id="friendZip" placeholder="ZIP Code">
                </div>
                <div class="form-group">
                    <input type="tel" id="friendPhone" placeholder="Phone (optional)">
                </div>
                <div class="form-group">
                    <input type="email" id="friendEmail" placeholder="Email (optional)">
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">Add Friend</button>
                    <button type="button" class="btn btn-cancel" onclick="hideAddModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // State management
        let friends = [];
        let map = null;
        let markers = [];
        let geocoder = null;
        let geocodeQueue = [];
        let isGeocoding = false;
        let searchTerm = '';
        let geocodeStats = { success: 0, failed: 0, pending: 0 };
        
        // Initialize Google Maps
        function initMap() {
            try {
                const mapDiv = document.getElementById('map');
                if (window.google && window.google.maps && mapDiv) {
                    map = new google.maps.Map(mapDiv, {
                        zoom: 4,
                        center: { lat: 39.8283, lng: -98.5795 },
                        mapTypeControl: false,
                        streetViewControl: false
                    });
                    
                    geocoder = new google.maps.Geocoder();
                    loadSavedData();
                    updateMapMarkers();
                }
            } catch (e) {
                console.log('Map initialization error:', e);
            }
        }
        
        // Load Google Maps script
        if (typeof google === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyCAHA2rJUh_pVQgH_N-AFc35UEfiR5jr70&callback=initMap';
            script.async = true;
            document.head.appendChild(script);
        }
        
        // Parse vCard
        function parseVCard(text) {
            const contacts = [];
            const vcards = text.split('BEGIN:VCARD').filter(v => v.trim());
            
            vcards.forEach((vcard, idx) => {
                const contact = { 
                    id: Date.now() + idx,
                    geocodeStatus: 'pending'
                };
                
                const lines = vcard.split(/\r?\n/);
                let field = '', value = '';
                
                lines.forEach(line => {
                    if (line.startsWith(' ') || line.startsWith('\t')) {
                        value += line.substring(1);
                    } else {
                        if (field) processVCardField(contact, field, value);
                        const colonIdx = line.indexOf(':');
                        if (colonIdx > 0) {
                            field = line.substring(0, colonIdx);
                            value = line.substring(colonIdx + 1);
                        }
                    }
                });
                
                if (field) processVCardField(contact, field, value);
                
                if (contact.name && (contact.city || contact.state)) {
                    contacts.push(contact);
                }
            });
            
            return contacts;
        }
        
        function processVCardField(contact, field, value) {
            const decode = str => str ? str.replace(/=([0-9A-F]{2})/gi, (m, h) => 
                String.fromCharCode(parseInt(h, 16))).replace(/=\r?\n/g, '') : '';
            
            if (field.includes('FN')) {
                contact.name = decode(value);
            } else if (field.includes('N') && !contact.name) {
                const parts = value.split(';');
                contact.name = (decode(parts[1] || '') + ' ' + decode(parts[0] || '')).trim();
            } else if (field.includes('TEL')) {
                contact.phone = value.replace(/[^\d+()-\s]/g, '');
            } else if (field.includes('EMAIL')) {
                contact.email = value;
            } else if (field.includes('ADR')) {
                const parts = value.split(';').map(decode);
                if (parts.length >= 6) {
                    contact.address = parts[2];
                    contact.city = parts[3];
                    contact.state = parts[4];
                    contact.zipCode = parts[5];
                }
            }
        }
        
        // Geocoding
        async function processGeocodeQueue() {
            if (isGeocoding || !geocoder || geocodeQueue.length === 0) return;
            
            isGeocoding = true;
            showProgress();
            
            while (geocodeQueue.length > 0 && isGeocoding) {
                const batch = geocodeQueue.splice(0, 5);
                
                for (const friend of batch) {
                    if (!isGeocoding) break;
                    
                    const addr = [friend.address, friend.city, friend.state, friend.zipCode]
                        .filter(Boolean).join(', ');
                    
                    if (addr.length > 3) {
                        const result = await geocodeAddress(addr);
                        if (result) {
                            friend.lat = result.lat;
                            friend.lng = result.lng;
                            friend.geocodeStatus = 'success';
                            geocodeStats.success++;
                        } else {
                            friend.geocodeStatus = 'failed';
                            geocodeStats.failed++;
                        }
                    } else {
                        friend.geocodeStatus = 'failed';
                        geocodeStats.failed++;
                    }
                    
                    geocodeStats.pending = geocodeQueue.length;
                    updateProgress();
                    await sleep(300);
                }
                
                updateMapMarkers();
                saveData();
            }
            
            isGeocoding = false;
            setTimeout(hideProgress, 2000);
        }
        
        function geocodeAddress(address) {
            return new Promise(resolve => {
                if (!geocoder) {
                    resolve(null);
                    return;
                }
                geocoder.geocode({ address }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const loc = results[0].geometry.location;
                        resolve({ lat: loc.lat(), lng: loc.lng() });
                    } else {
                        resolve(null);
                    }
                });
            });
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // UI Updates
        function updateFriendsList() {
            const list = document.getElementById('friendsList');
            const filtered = friends.filter(f => {
                const s = searchTerm.toLowerCase();
                return f.name.toLowerCase().includes(s) ||
                       (f.city && f.city.toLowerCase().includes(s)) ||
                       (f.state && f.state.toLowerCase().includes(s));
            });
            
            document.getElementById('friendCount').textContent = `üë• ${friends.length} friends`;
            
            if (filtered.length === 0 && friends.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <div>No friends added yet</div>
                        <div style="font-size: 13px; margin-top: 8px;">Add your first friend or import contacts!</div>
                    </div>
                `;
            } else {
                list.innerHTML = filtered.slice(0, 100).map(f => {
                    const status = f.geocodeStatus === 'success' ? 'üìç' : 
                                  f.geocodeStatus === 'pending' ? '‚è≥' : '‚ùå';
                    return `
                        <div class="friend-item" onclick="centerOnFriend(${f.id})">
                            <div class="friend-info">
                                <div class="friend-name">${f.name} ${status}</div>
                                <div class="friend-location">${f.city || 'Unknown'}, ${f.state || ''}</div>
                            </div>
                            <div class="friend-actions">
                                <button class="icon-btn" onclick="event.stopPropagation(); deleteFriend(${f.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                if (filtered.length > 100) {
                    list.innerHTML += `<div style="text-align: center; padding: 10px; color: #999;">
                        ... and ${filtered.length - 100} more</div>`;
                }
            }
        }
        
        function updateMapMarkers() {
            if (!map) return;
            
            markers.forEach(m => m.setMap(null));
            markers = [];
            
            const valid = friends.filter(f => f.lat && f.lng);
            
            valid.forEach(f => {
                const marker = new google.maps.Marker({
                    position: { lat: f.lat, lng: f.lng },
                    map: map,
                    title: f.name
                });
                
                const info = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px;">
                            <strong>${f.name}</strong><br>
                            ${f.city || 'Unknown'}, ${f.state || ''}<br>
                            ${f.phone ? 'üìû ' + f.phone + '<br>' : ''}
                            ${f.email ? '‚úâÔ∏è ' + f.email : ''}
                        </div>
                    `
                });
                
                marker.addListener('click', () => info.open(map, marker));
                markers.push(marker);
            });
            
            if (markers.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                valid.forEach(f => bounds.extend({ lat: f.lat, lng: f.lng }));
                map.fitBounds(bounds);
            }
            
            document.getElementById('mapStatus').textContent = 
                valid.length > 0 ? `${valid.length} on map` : '';
        }
        
        function showProgress() {
            document.getElementById('progressBar').style.display = 'block';
            document.getElementById('statsPanel').style.display = 'block';
        }
        
        function hideProgress() {
            document.getElementById('progressBar').style.display = 'none';
        }
        
        function updateProgress() {
            const total = geocodeStats.success + geocodeStats.failed + geocodeStats.pending;
            const done = geocodeStats.success + geocodeStats.failed;
            const percent = total > 0 ? Math.round((done / total) * 100) : 0;
            
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressStats').textContent = 
                `Processed: ${done}/${total} | Success: ${geocodeStats.success} | Failed: ${geocodeStats.failed}`;
            
            document.getElementById('totalStat').textContent = friends.length;
            document.getElementById('geocodedStat').textContent = geocodeStats.success;
            document.getElementById('pendingStat').textContent = geocodeStats.pending;
            document.getElementById('failedStat').textContent = geocodeStats.failed;
        }
        
        // Actions
        function centerOnFriend(id) {
            const friend = friends.find(f => f.id === id);
            if (friend && friend.lat && friend.lng && map) {
                map.setCenter({ lat: friend.lat, lng: friend.lng });
                map.setZoom(14);
            }
        }
        
        function deleteFriend(id) {
            if (confirm('Delete this friend?')) {
                friends = friends.filter(f => f.id !== id);
                updateFriendsList();
                updateMapMarkers();
                saveData();
            }
        }
        
        function showAddModal() {
            document.getElementById('addModal').style.display = 'flex';
        }
        
        function hideAddModal() {
            document.getElementById('addModal').style.display = 'none';
            document.getElementById('addForm').reset();
        }
        
        function addFriend(e) {
            e.preventDefault();
            
            const friend = {
                id: Date.now(),
                name: document.getElementById('friendName').value,
                address: document.getElementById('friendAddress').value,
                city: document.getElementById('friendCity').value,
                state: document.getElementById('friendState').value,
                zipCode: document.getElementById('friendZip').value,
                phone: document.getElementById('friendPhone').value,
                email: document.getElementById('friendEmail').value,
                geocodeStatus: 'pending'
            };
            
            friends.push(friend);
            geocodeQueue.push(friend);
            
            hideAddModal();
            updateFriendsList();
            saveData();
            processGeocodeQueue();
        }
        
        function triggerImport() {
            document.getElementById('fileInput').click();
        }
        
        function handleImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                
                if (file.name.endsWith('.json')) {
                    try {
                        friends = JSON.parse(content);
                        updateFriendsList();
                        updateMapMarkers();
                        saveData();
                        alert(`Imported ${friends.length} contacts`);
                    } catch (err) {
                        alert('Invalid JSON file');
                    }
                } else if (content.includes('BEGIN:VCARD')) {
                    const contacts = parseVCard(content);
                    if (contacts.length === 0) {
                        alert('No valid contacts found');
                        return;
                    }
                    
                    geocodeStats = { success: 0, failed: 0, pending: contacts.length };
                    friends = friends.concat(contacts);
                    geocodeQueue = contacts;
                    
                    updateFriendsList();
                    saveData();
                    
                    alert(`Found ${contacts.length} contacts. Starting geocoding...`);
                    processGeocodeQueue();
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }
        
        function exportData() {
            const data = JSON.stringify(friends, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'friend-map-export.json';
            a.click();
        }
        
        function saveData() {
            try {
                localStorage.setItem('friendMapData', JSON.stringify(friends));
            } catch (e) {
                console.log('Save failed:', e);
            }
        }
        
        function loadSavedData() {
            try {
                const saved = localStorage.getItem('friendMapData');
                if (saved) {
                    friends = JSON.parse(saved);
                    geocodeStats = {
                        success: friends.filter(f => f.geocodeStatus === 'success').length,
                        failed: friends.filter(f => f.geocodeStatus === 'failed').length,
                        pending: friends.filter(f => f.geocodeStatus === 'pending').length
                    };
                    updateFriendsList();
                    
                    const pending = friends.filter(f => f.geocodeStatus === 'pending');
                    if (pending.length > 0) {
                        geocodeQueue = pending;
                        processGeocodeQueue();
                    }
                }
            } catch (e) {
                console.log('Load failed:', e);
            }
        }
        
        // Event listeners
        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchTerm = e.target.value;
            updateFriendsList();
        });
        
        document.getElementById('fileInput').addEventListener('change', handleImport);
        
        document.getElementById('addModal').addEventListener('click', (e) => {
            if (e.target.id === 'addModal') hideAddModal();
        });
        
        // Initialize
        updateFriendsList();
        window.initMap = initMap;
    </script>
</body>
</html>
