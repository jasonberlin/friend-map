<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friend Map</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üó∫Ô∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="app" class="min-h-screen bg-gray-50">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-3">
                        <svg class="h-8 w-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <h1 class="text-2xl font-bold text-gray-900">Friend Map</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="flex items-center text-gray-600">
                            <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
                            </svg>
                            <span id="friendCount">0 friends</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Sidebar -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-lg font-semibold text-gray-900">Your Friends</h2>
                            <div class="flex space-x-2">
                                <button id="addBtn" class="bg-blue-600 text-white px-3 py-2 rounded-md text-sm hover:bg-blue-700 flex items-center">
                                    + Add
                                </button>
                                <button id="importBtn" class="bg-green-600 text-white px-3 py-2 rounded-md text-sm hover:bg-green-700 flex items-center">
                                    ‚Üë Import
                                </button>
                            </div>
                        </div>

                        <input type="file" id="fileInput" accept=".vcf" style="display: none;">

                        <!-- Search -->
                        <div class="mb-4">
                            <input type="text" id="searchInput" placeholder="Search friends..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <!-- Friends List -->
                        <div id="friendsList" class="space-y-3 max-h-96 overflow-y-auto">
                            <div id="emptyState" class="text-center py-8 text-gray-500">
                                <svg class="h-12 w-12 mx-auto mb-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
                                </svg>
                                <p>No friends added yet.</p>
                                <p class="text-sm">Add your first friend to get started!</p>
                            </div>
                        </div>

                        <!-- Import Instructions -->
                        <div class="mt-6 p-4 bg-blue-50 rounded-md">
                            <h4 class="text-sm font-medium text-blue-900 mb-3">üì± Import Apple Contacts</h4>
                            <div class="space-y-2 text-xs text-blue-700">
                                <div>1. Go to <span class="font-mono">icloud.com</span> ‚Üí Sign in</div>
                                <div>2. Click "Contacts" ‚Üí Select All</div>
                                <div>3. Export vCard ‚Üí Upload here</div>
                                <div class="mt-2 p-2 bg-amber-50 rounded text-amber-700">
                                    üí° Only contacts with addresses will appear on the map
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Map -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div id="map" class="w-full h-96 lg:h-[600px]" style="background: #f3f4f6;">
                            <div id="mapPlaceholder" class="w-full h-full flex items-center justify-center text-gray-500">
                                <div class="text-center">
                                    <svg class="h-12 w-12 mx-auto mb-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    <p>Loading Google Maps...</p>
                                    <p class="text-xs mt-2">Using your active API key</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Friend Modal -->
    <div id="addModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Add New Friend</h3>
            <div class="space-y-4">
                <input type="text" id="friendName" placeholder="Name" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                <input type="text" id="friendAddress" placeholder="Street Address" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="friendCity" placeholder="City" class="px-3 py-2 border border-gray-300 rounded-md">
                    <input type="text" id="friendState" placeholder="State" class="px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <input type="text" id="friendZip" placeholder="ZIP Code" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                <input type="text" id="friendPhone" placeholder="Phone (optional)" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                <input type="email" id="friendEmail" placeholder="Email (optional)" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                <div class="flex space-x-4">
                    <button id="saveFriend" class="flex-1 bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Add Friend</button>
                    <button id="cancelAdd" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-md hover:bg-gray-400">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Card Modal -->
    <div id="contactModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm relative">
            <button id="closeContact" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
            <div class="text-center mb-6">
                <div id="contactAvatar" class="w-20 h-20 rounded-full mx-auto mb-4 bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white text-2xl font-bold"></div>
                <h3 id="contactName" class="text-xl font-bold text-gray-900 mb-2"></h3>
            </div>
            <div id="contactDetails" class="space-y-4"></div>
            <div id="contactActions" class="mt-6 flex flex-wrap gap-2"></div>
        </div>
    </div>

    <script>
        // Friend Map App - Vanilla JavaScript
        let friends = [];
        let map = null;
        let markers = [];
        let searchTerm = '';

        // Initialize Google Maps
        function initMap() {
            if (window.google && document.getElementById('map')) {
                const mapPlaceholder = document.getElementById('mapPlaceholder');
                if (mapPlaceholder) mapPlaceholder.style.display = 'none';
                
                map = new window.google.maps.Map(document.getElementById('map'), {
                    zoom: 4,
                    center: { lat: 39.8283, lng: -98.5795 },
                    styles: [{ featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] }]
                });
                updateMapMarkers();
            }
        }

        // Load Google Maps
        function loadGoogleMaps() {
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyCAHA2rJUh_pVQgH_N-AFc35UEfiR5jr70&libraries=geocoding&callback=initMap';
            script.async = true;
            document.head.appendChild(script);
        }

        // Geocode address
        async function geocodeAddress(address) {
            return new Promise((resolve) => {
                if (!window.google || !window.google.maps) {
                    resolve({ lat: 40.7128 + (Math.random() - 0.5) * 20, lng: -74.0060 + (Math.random() - 0.5) * 40 });
                    return;
                }
                const geocoder = new window.google.maps.Geocoder();
                geocoder.geocode({ address }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const location = results[0].geometry.location;
                        resolve({ lat: location.lat(), lng: location.lng() });
                    } else {
                        resolve({ lat: 39.8283 + (Math.random() - 0.5) * 10, lng: -98.5795 + (Math.random() - 0.5) * 20 });
                    }
                });
            });
        }

        // Parse vCard
        function parseVCard(vcardText) {
            const contacts = [];
            const vcards = vcardText.split('BEGIN:VCARD');
            vcards.forEach((vcard, index) => {
                if (index === 0) return;
                const lines = vcard.split('\n').map(line => line.trim()).filter(line => line);
                const contact = { id: Date.now() + index };
                lines.forEach(line => {
                    if (line.startsWith('FN:')) {
                        contact.name = line.substring(3).trim();
                    } else if (line.startsWith('N:') && !contact.name) {
                        const nameParts = line.substring(2).split(';');
                        contact.name = ((nameParts[1] || '') + ' ' + (nameParts[0] || '')).trim();
                    } else if (line.startsWith('TEL')) {
                        const phoneMatch = line.match(/TEL[^:]*:(.*)/);
                        if (phoneMatch && !contact.phone) contact.phone = phoneMatch[1].trim();
                    } else if (line.startsWith('EMAIL')) {
                        const emailMatch = line.match(/EMAIL[^:]*:(.*)/);
                        if (emailMatch && !contact.email) contact.email = emailMatch[1].trim();
                    } else if (line.startsWith('ADR')) {
                        const addrMatch = line.match(/ADR[^:]*:(.*)/);
                        if (addrMatch) {
                            const addrParts = addrMatch[1].split(';');
                            contact.address = addrParts[2] || '';
                            contact.city = addrParts[3] || '';
                            contact.state = addrParts[4] || '';
                            contact.zipCode = addrParts[5] || '';
                        }
                    }
                });
                if (contact.name && (contact.address || contact.city)) {
                    contacts.push(contact);
                }
            });
            return contacts;
        }

        // Update friends list display
        function updateFriendsList() {
            const friendsList = document.getElementById('friendsList');
            const emptyState = document.getElementById('emptyState');
            const friendCount = document.getElementById('friendCount');
            
            const filteredFriends = friends.filter(friend =>
                friend.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                friend.city.toLowerCase().includes(searchTerm.toLowerCase()) ||
                friend.state.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            friendCount.textContent = friends.length + ' friends';
            
            if (filteredFriends.length === 0) {
                emptyState.style.display = 'block';
                friendsList.innerHTML = '';
                friendsList.appendChild(emptyState);
            } else {
                emptyState.style.display = 'none';
                friendsList.innerHTML = '';
                filteredFriends.forEach(friend => {
                    const friendDiv = document.createElement('div');
                    friendDiv.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-md';
                    friendDiv.innerHTML = `
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-900">${friend.name}</h3>
                            <p class="text-sm text-gray-600">${friend.city}, ${friend.state}</p>
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="editFriend(${friend.id})" class="p-1 text-gray-400 hover:text-blue-600">‚úèÔ∏è</button>
                            <button onclick="deleteFriend(${friend.id})" class="p-1 text-gray-400 hover:text-red-600">üóëÔ∏è</button>
                        </div>
                    `;
                    friendsList.appendChild(friendDiv);
                });
            }
        }

        // Update map markers
        function updateMapMarkers() {
            if (!map) return;
            
            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            friends.forEach(friend => {
                if (friend.lat && friend.lng) {
                    const marker = new window.google.maps.Marker({
                        position: { lat: friend.lat, lng: friend.lng },
                        map: map,
                        title: friend.name,
                        icon: {
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#EF4444"><path d="M12 0C7.802 0 4.4 3.403 4.4 7.602 4.4 11.8 12 24 12 24s7.6-12.2 7.6-16.398C19.6 3.403 16.197 0 12 0zM12 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/></svg>'),
                            scaledSize: new window.google.maps.Size(32, 32)
                        }
                    });
                    
                    marker.addListener('click', () => showContactCard(friend));
                    markers.push(marker);
                }
            });
            
            // Fit map to markers
            if (markers.length > 0) {
                const bounds = new window.google.maps.LatLngBounds();
                friends.forEach(friend => {
                    if (friend.lat && friend.lng) {
                        bounds.extend({ lat: friend.lat, lng: friend.lng });
                    }
                });
                map.fitBounds(bounds);
            }
        }

        // Show contact card
        function showContactCard(friend) {
            const modal = document.getElementById('contactModal');
            const avatar = document.getElementById('contactAvatar');
            const name = document.getElementById('contactName');
            const details = document.getElementById('contactDetails');
            const actions = document.getElementById('contactActions');
            
            avatar.textContent = friend.name.split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
            name.textContent = friend.name;
            
            details.innerHTML = '';
            actions.innerHTML = '';
            
            if (friend.phone) {
                details.innerHTML += `
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">üìû</div>
                        <div>
                            <p class="text-sm text-gray-500">Phone</p>
                            <p class="text-gray-900 font-medium">${friend.phone}</p>
                        </div>
                    </div>
                `;
                actions.innerHTML += `<a href="tel:${friend.phone}" class="bg-green-600 text-white py-2 px-4 rounded-lg text-center text-sm font-medium hover:bg-green-700">Call</a>`;
            }
            
            if (friend.email) {
                details.innerHTML += `
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">‚úâÔ∏è</div>
                        <div>
                            <p class="text-sm text-gray-500">Email</p>
                            <p class="text-gray-900 font-medium">${friend.email}</p>
                        </div>
                    </div>
                `;
                actions.innerHTML += `<a href="mailto:${friend.email}" class="bg-blue-600 text-white py-2 px-4 rounded-lg text-center text-sm font-medium hover:bg-blue-700">Email</a>`;
            }
            
            details.innerHTML += `
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">üìç</div>
                    <div>
                        <p class="text-sm text-gray-500">Address</p>
                        <p class="text-gray-900 font-medium">
                            ${friend.address ? friend.address + ', ' : ''}${friend.city}, ${friend.state} ${friend.zipCode}
                        </p>
                    </div>
                </div>
            `;
            
            actions.innerHTML += `<button onclick="editFriend(${friend.id}); closeContactCard();" class="bg-gray-600 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-gray-700">Edit</button>`;
            
            modal.style.display = 'flex';
        }

        // Close contact card
        function closeContactCard() {
            document.getElementById('contactModal').style.display = 'none';
        }

        // Add friend
        async function addFriend() {
            const name = document.getElementById('friendName').value;
            const address = document.getElementById('friendAddress').value;
            const city = document.getElementById('friendCity').value;
            const state = document.getElementById('friendState').value;
            const zipCode = document.getElementById('friendZip').value;
            const phone = document.getElementById('friendPhone').value;
            const email = document.getElementById('friendEmail').value;
            
            if (!name || !city || !state) {
                alert('Please fill in name, city, and state');
                return;
            }
            
            const fullAddress = address + ', ' + city + ', ' + state + ' ' + zipCode;
            const coords = await geocodeAddress(fullAddress);
            
            friends.push({
                id: Date.now(),
                name, address, city, state, zipCode, phone, email,
                lat: coords.lat,
                lng: coords.lng
            });
            
            // Clear form
            document.getElementById('friendName').value = '';
            document.getElementById('friendAddress').value = '';
            document.getElementById('friendCity').value = '';
            document.getElementById('friendState').value = '';
            document.getElementById('friendZip').value = '';
            document.getElementById('friendPhone').value = '';
            document.getElementById('friendEmail').value = '';
            
            document.getElementById('addModal').style.display = 'none';
            updateFriendsList();
            updateMapMarkers();
        }

        // Edit friend
        function editFriend(id) {
            const friend = friends.find(f => f.id === id);
            if (friend) {
                document.getElementById('friendName').value = friend.name;
                document.getElementById('friendAddress').value = friend.address;
                document.getElementById('friendCity').value = friend.city;
                document.getElementById('friendState').value = friend.state;
                document.getElementById('friendZip').value = friend.zipCode;
                document.getElementById('friendPhone').value = friend.phone || '';
                document.getElementById('friendEmail').value = friend.email || '';
                document.getElementById('addModal').style.display = 'flex';
            }
        }

        // Delete friend
        function deleteFriend(id) {
            friends = friends.filter(f => f.id !== id);
            updateFriendsList();
            updateMapMarkers();
        }

        // Handle file upload
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const content = e.target.result;
                if (content.includes('BEGIN:VCARD')) {
                    const vcardContacts = parseVCard(content);
                    let importedCount = 0;
                    
                    for (const contact of vcardContacts) {
                        if (contact.name && (contact.address || contact.city)) {
                            const fullAddress = contact.address ? 
                                contact.address + ', ' + contact.city + ', ' + contact.state + ' ' + contact.zipCode :
                                contact.city + ', ' + contact.state + ' ' + contact.zipCode;
                            
                            try {
                                const coords = await geocodeAddress(fullAddress.trim());
                                friends.push({ ...contact, lat: coords.lat, lng: coords.lng });
                                importedCount++;
                            } catch (error) {
                                console.error('Error geocoding:', contact.name);
                            }
                        }
                    }
                    
                    if (importedCount > 0) {
                        alert('Successfully imported ' + importedCount + ' contacts with addresses!');
                        updateFriendsList();
                        updateMapMarkers();
                    } else {
                        alert('No contacts with addresses found in the file.');
                    }
                }
            };
            reader.readAsText(file);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadGoogleMaps();
            
            document.getElementById('addBtn').onclick = () => document.getElementById('addModal').style.display = 'flex';
            document.getElementById('importBtn').onclick = () => document.getElementById('fileInput').click();
            document.getElementById('cancelAdd').onclick = () => document.getElementById('addModal').style.display = 'none';
            document.getElementById('saveFriend').onclick = addFriend;
            document.getElementById('closeContact').onclick = closeContactCard;
            document.getElementById('fileInput').onchange = handleFileUpload;
            document.getElementById('searchInput').oninput = (e) => {
                searchTerm = e.target.value;
                updateFriendsList();
            };
            
            // Close modals when clicking outside
            document.getElementById('addModal').onclick = (e) => {
                if (e.target.id === 'addModal') document.getElementById('addModal').style.display = 'none';
            };
            document.getElementById('contactModal').onclick = (e) => {
                if (e.target.id === 'contactModal') closeContactCard();
            };
            
            updateFriendsList();
        });
    </script>
</body>
</html>
