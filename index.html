<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friend Map - Plot Your Network</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üó∫Ô∏è</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            color: #1c1e21;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stats-bar {
            display: flex;
            gap: 24px;
            align-items: center;
            font-size: 14px;
            color: #65676b;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1c1e21;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
            transform: translateY(-1px);
        }
        
        .btn-warning {
            background: #ed8936;
            color: white;
        }
        
        .btn-warning:hover {
            background: #dd6b20;
            transform: translateY(-1px);
        }
        
        .search-box {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e4e6eb;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
            transition: border-color 0.2s;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
            display: none;
        }
        
        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        
        .alert-warning {
            background: #feebc8;
            color: #744210;
            border: 1px solid #f6ad55;
        }
        
        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #68d391;
        }
        
        .progress-container {
            background: #f0f2f5;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .progress-bar {
            height: 6px;
            background: #e4e6eb;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }
        
        .progress-stats {
            margin-top: 8px;
            font-size: 12px;
            color: #65676b;
        }
        
        .friends-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e4e6eb;
            border-radius: 8px;
            padding: 8px;
        }
        
        .friend-card {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .friend-card:hover {
            background: #e9ecef;
            transform: translateX(4px);
        }
        
        .friend-info {
            flex: 1;
        }
        
        .friend-name {
            font-weight: 500;
            color: #1c1e21;
            margin-bottom: 2px;
        }
        
        .friend-location {
            font-size: 12px;
            color: #65676b;
        }
        
        .friend-status {
            font-size: 16px;
            margin-right: 8px;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #e03e3e;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .delete-btn:hover {
            opacity: 1;
        }
        
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #65676b;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .map-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            height: 600px;
            position: relative;
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .map-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .map-loading-content {
            text-align: center;
        }
        
        .map-error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 24px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }
        
        .instructions {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .instructions h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1c1e21;
        }
        
        .instructions ol {
            font-size: 13px;
            color: #65676b;
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 6px;
        }
        
        .tip {
            background: #fff4e6;
            border: 1px solid #ffb74d;
            color: #e65100;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 12px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 12px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #1c1e21;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #65676b;
            margin-bottom: 6px;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e4e6eb;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 12px;
        }
        
        .btn-cancel {
            background: #e4e6eb;
            color: #1c1e21;
        }
        
        .btn-cancel:hover {
            background: #d1d5db;
        }
        
        .quota-info {
            background: #e8f4fd;
            border: 1px solid #60a5fa;
            color: #1e40af;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .map-container {
                height: 400px;
            }
            
            .sidebar {
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="logo">
                    <span style="font-size: 32px;">üó∫Ô∏è</span>
                    <h1>Friend Map</h1>
                </div>
                <div class="stats-bar">
                    <span>üë• <strong id="totalCount">0</strong> friends</span>
                    <span>üìç <strong id="geocodedCount">0</strong> mapped</span>
                    <span>‚è≥ <strong id="pendingCount">0</strong> pending</span>
                </div>
            </div>
        </div>
        
        <div class="main-layout">
            <div class="sidebar">
                <h2 class="section-title">Manage Friends</h2>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="showAddModal()">
                        <span>‚ûï</span> Add
                    </button>
                    <button class="btn btn-success" onclick="document.getElementById('fileInput').click()">
                        <span>üì§</span> Import
                    </button>
                    <button class="btn btn-warning" onclick="exportData()">
                        <span>üíæ</span> Export
                    </button>
                </div>
                
                <div class="button-group" style="margin-top: 8px;">
                    <button class="btn btn-success" onclick="retryFailed()" title="Retry failed geocoding">
                        <span>üîÑ</span> Retry
                    </button>
                    <button class="btn btn-primary" onclick="updateContacts()" title="Re-import to update">
                        <span>üîÑ</span> Update
                    </button>
                    <button class="btn btn-cancel" onclick="clearAllData()" title="Clear all data">
                        <span>üóëÔ∏è</span> Clear
                    </button>
                </div>
                
                <input type="file" id="fileInput" accept=".vcf,.json" style="display: none;" onchange="handleImport(event)">
                
                <div class="quota-info" id="quotaInfo">
                    <strong>Free Tier Status:</strong><br>
                    Maps: Unlimited views<br>
                    Geocoding: <span id="geocodeCount">0</span> / 40,000 this month<br>
                    <small>Resets monthly. $200 free credit covers all usage.</small>
                </div>
                
                <div class="alert alert-error" id="errorAlert"></div>
                <div class="alert alert-warning" id="warningAlert"></div>
                <div class="alert alert-success" id="successAlert"></div>
                
                <input type="text" class="search-box" id="searchBox" placeholder="Search by name or location...">
                
                <div class="progress-container" id="progressContainer">
                    <div class="progress-header">
                        <span>Processing contacts...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-stats" id="progressStats">
                        Waiting to start...
                    </div>
                    <button class="btn btn-cancel" style="width: 100%; margin-top: 12px;" onclick="stopGeocoding()">
                        Stop Processing
                    </button>
                </div>
                
                <div class="friends-list" id="friendsList">
                    <div class="empty-state">
                        <div class="empty-icon">üë•</div>
                        <div style="font-weight: 500; margin-bottom: 8px;">No friends yet</div>
                        <div style="font-size: 13px;">Import your contacts or add friends manually</div>
                    </div>
                </div>
                
                <div class="instructions">
                    <h3>üì± Import from iPhone/Mac</h3>
                    <ol>
                        <li>Go to <strong>icloud.com</strong></li>
                        <li>Sign in with your Apple ID</li>
                        <li>Open <strong>Contacts</strong></li>
                        <li>Select all (Cmd+A or Ctrl+A)</li>
                        <li>Click gear icon ‚Üí <strong>Export vCard</strong></li>
                        <li>Upload the .vcf file here</li>
                    </ol>
                    <div class="tip">
                        üí° <strong>Save Your Map:</strong> Use "Export" to save a backup JSON file. You can import it later to restore your map with all geocoded locations intact!
                    </div>
                    <div class="tip" style="margin-top: 8px;">
                        üîÑ <strong>Update Contacts:</strong> Re-import your vCard anytime. The app will automatically detect and add only new contacts.
                    </div>
                </div>
            </div>
            
            <div class="map-container">
                <div id="map">
                    <div class="map-loading" id="mapLoading">
                        <div class="map-loading-content">
                            <div style="font-size: 64px; margin-bottom: 16px;">üó∫Ô∏è</div>
                            <h2>Initializing Map...</h2>
                            <p style="margin-top: 8px; opacity: 0.9;">Loading Google Maps API</p>
                        </div>
                    </div>
                    <div class="map-error" id="mapError">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                        <h3>Map Loading Error</h3>
                        <p style="margin: 16px 0; color: #65676b;">Could not load Google Maps. Check:</p>
                        <ul style="text-align: left; color: #65676b; font-size: 14px;">
                            <li>API key is valid</li>
                            <li>Billing is enabled</li>
                            <li>APIs are enabled</li>
                        </ul>
                        <button class="btn btn-primary" onclick="location.reload()">Retry</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="addModal">
        <div class="modal-content">
            <h2 class="modal-title">Add New Friend</h2>
            <form id="addForm" onsubmit="addFriend(event)">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="inputName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Street Address</label>
                    <input type="text" class="form-input" id="inputAddress">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">City *</label>
                        <input type="text" class="form-input" id="inputCity" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">State *</label>
                        <input type="text" class="form-input" id="inputState" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ZIP Code</label>
                        <input type="text" class="form-input" id="inputZip">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Country</label>
                        <input type="text" class="form-input" id="inputCountry" value="USA">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" id="inputPhone">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="inputEmail">
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">Add Friend</button>
                    <button type="button" class="btn btn-cancel" onclick="hideAddModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Global state
        let friends = [];
        let map = null;
        let geocoder = null;
        let markers = [];
        let infoWindows = [];
        let geocodeQueue = [];
        let isGeocoding = false;
        let geocodeCount = 0;
        let searchTerm = '';
        
        // Initialize map
        function initMap() {
            try {
                const mapDiv = document.getElementById('map');
                if (!mapDiv) return;
                
                // Hide loading, show map
                document.getElementById('mapLoading').style.display = 'none';
                
                map = new google.maps.Map(mapDiv, {
                    zoom: 4,
                    center: { lat: 39.8283, lng: -98.5795 },
                    mapTypeControl: true,
                    streetViewControl: false,
                    fullscreenControl: true
                });
                
                geocoder = new google.maps.Geocoder();
                
                // Load saved data
                loadFromStorage();
                updateDisplay();
                
                showAlert('success', 'Map loaded successfully! Ready to import contacts.');
                
            } catch (error) {
                console.error('Map init error:', error);
                showMapError();
            }
        }
        
        // Show map error
        function showMapError() {
            document.getElementById('mapLoading').style.display = 'none';
            document.getElementById('mapError').style.display = 'block';
            showAlert('error', 'Failed to load Google Maps. Check console for details.');
        }
        
        // Load Google Maps script
        window.gm_authFailure = function() {
            showMapError();
            showAlert('error', 'Google Maps authentication failed. Check your API key restrictions.');
        };
        
        // Parse vCard
        function parseVCard(text) {
            const contacts = [];
            const vcards = text.split('BEGIN:VCARD');
            
            for (let i = 1; i < vcards.length; i++) {
                const vcard = vcards[i];
                const contact = {
                    id: Date.now() + i,
                    status: 'pending'
                };
                
                // Extract fields
                const getField = (field) => {
                    const regex = new RegExp(`${field}[^:]*:(.*)`, 'i');
                    const match = vcard.match(regex);
                    return match ? match[1].trim() : '';
                };
                
                // Name
                contact.name = getField('FN');
                if (!contact.name) {
                    const n = getField('N');
                    if (n) {
                        const parts = n.split(';');
                        contact.name = `${parts[1] || ''} ${parts[0] || ''}`.trim();
                    }
                }
                
                // Phone
                const tel = vcard.match(/TEL[^:]*:([\s\S]*?)(?:\r?\n(?=[A-Z])|\r?\n$)/);
                if (tel) contact.phone = tel[1].replace(/[^0-9+()-\s]/g, '').trim();
                
                // Email
                const email = vcard.match(/EMAIL[^:]*:([\s\S]*?)(?:\r?\n(?=[A-Z])|\r?\n$)/);
                if (email) contact.email = email[1].trim();
                
                // Address
                const adr = vcard.match(/ADR[^:]*:([\s\S]*?)(?:\r?\n(?=[A-Z])|\r?\n$)/);
                if (adr) {
                    const parts = adr[1].split(';');
                    contact.address = parts[2] || '';
                    contact.city = parts[3] || '';
                    contact.state = parts[4] || '';
                    contact.zip = parts[5] || '';
                    contact.country = parts[6] || 'USA';
                }
                
                // Only add if has name and location
                if (contact.name && (contact.city || contact.state)) {
                    contacts.push(contact);
                }
            }
            
            return contacts;
        }
        
        // Geocoding with rate limiting
        async function processGeocodeQueue() {
            if (isGeocoding || !geocoder || geocodeQueue.length === 0) return;
            
            console.log('Starting geocoding for', geocodeQueue.length, 'addresses');
            console.log('Current friends count:', friends.length);
            
            isGeocoding = true;
            document.getElementById('progressContainer').style.display = 'block';
            
            const total = geocodeQueue.length;
            let processed = 0;
            let success = 0;
            let failed = 0;
            
            // Test with first address to check for API issues
            if (geocodeQueue.length > 0) {
                const testFriend = geocodeQueue[0];
                const testAddress = [testFriend.city, testFriend.state, 'USA'].filter(Boolean).join(', ');
                console.log('Testing geocoding with:', testAddress);
            }
            
            while (geocodeQueue.length > 0 && isGeocoding) {
                const friend = geocodeQueue.shift();
                
                // Find the friend in the main array and update it
                const friendIndex = friends.findIndex(f => f.id === friend.id);
                if (friendIndex === -1) {
                    console.error('Friend not found in main array:', friend.name);
                    continue;
                }
                
                // Build address - simplified for better success rate
                const parts = [];
                if (friend.city) parts.push(friend.city);
                if (friend.state) parts.push(friend.state);
                if (!friend.country || friend.country === 'USA') parts.push('USA');
                else parts.push(friend.country);
                
                const address = parts.join(', ');
                
                if (address.length > 5 && friend.city) {
                    try {
                        const result = await geocodeAddress(address);
                        if (result) {
                            // Update the friend in the main array
                            friends[friendIndex].lat = result.lat;
                            friends[friendIndex].lng = result.lng;
                            friends[friendIndex].status = 'geocoded';
                            success++;
                            geocodeCount++;
                            
                            console.log(`Geocoded ${friend.name}: ${result.lat}, ${result.lng}`);
                        } else {
                            friends[friendIndex].status = 'failed';
                            failed++;
                        }
                    } catch (error) {
                        console.error('Geocoding error:', error);
                        friends[friendIndex].status = 'failed';
                        failed++;
                        
                        if (error.message.includes('OVER_QUERY_LIMIT')) {
                            showAlert('warning', 'Rate limit reached. Waiting 2 seconds...');
                            await sleep(2000);
                            geocodeQueue.unshift(friend); // Add back to queue
                            continue;
                        }
                    }
                } else {
                    console.log('Skipping invalid address for:', friend.name);
                    friends[friendIndex].status = 'failed';
                    failed++;
                }
                
                processed++;
                
                // Update progress
                const percent = Math.round((processed / total) * 100);
                document.getElementById('progressPercent').textContent = `${percent}%`;
                document.getElementById('progressFill').style.width = `${percent}%`;
                document.getElementById('progressStats').textContent = 
                    `Processed: ${processed}/${total} | Success: ${success} | Failed: ${failed}`;
                
                // Update display periodically
                if (processed % 5 === 0 || processed === total) {
                    console.log('Updating display - Friends with coords:', 
                        friends.filter(f => f.lat && f.lng).length);
                    updateDisplay();
                    saveToStorage();
                }
                
                // Rate limiting: slower to be safe
                await sleep(100); // 10 requests per second max
            }
            
            isGeocoding = false;
            document.getElementById('progressContainer').style.display = 'none';
            
            console.log('Geocoding complete. Total friends:', friends.length);
            console.log('Friends with coordinates:', friends.filter(f => f.lat && f.lng).length);
            
            updateDisplay();
            saveToStorage();
            
            document.getElementById('geocodeCount').textContent = geocodeCount;
            
            if (success > 0) {
                showAlert('success', `Successfully mapped ${success} friends!`);
            } else if (failed > 0) {
                showAlert('error', `Failed to geocode addresses. Check console for details.`);
            }
        }
        
        function geocodeAddress(address) {
            return new Promise((resolve, reject) => {
                console.log('Geocoding address:', address);
                
                geocoder.geocode({ address }, (results, status) => {
                    console.log('Geocode status:', status);
                    
                    if (status === 'OK') {
                        const location = results[0].geometry.location;
                        console.log('Success! Location:', location.lat(), location.lng());
                        resolve({ lat: location.lat(), lng: location.lng() });
                    } else if (status === 'OVER_QUERY_LIMIT') {
                        console.error('Rate limit hit');
                        reject(new Error('OVER_QUERY_LIMIT'));
                    } else if (status === 'REQUEST_DENIED') {
                        console.error('REQUEST DENIED - Check API key and restrictions');
                        showAlert('error', 'Geocoding denied - check API key settings');
                        resolve(null);
                    } else if (status === 'INVALID_REQUEST') {
                        console.error('Invalid address:', address);
                        resolve(null);
                    } else {
                        console.warn('Geocode failed:', status, 'for address:', address);
                        resolve(null);
                    }
                });
            });
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function stopGeocoding() {
            isGeocoding = false;
            geocodeQueue = [];
            document.getElementById('progressContainer').style.display = 'none';
            showAlert('warning', 'Geocoding stopped by user');
        }
        
        // Display functions
        function updateDisplay() {
            updateStats();
            updateFriendsList();
            updateMap();
        }
        
        function updateStats() {
            const total = friends.length;
            const geocoded = friends.filter(f => f.status === 'geocoded').length;
            const pending = friends.filter(f => f.status === 'pending').length;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('geocodedCount').textContent = geocoded;
            document.getElementById('pendingCount').textContent = pending;
        }
        
        function updateFriendsList() {
            const list = document.getElementById('friendsList');
            const filtered = friends.filter(f => {
                if (!searchTerm) return true;
                const search = searchTerm.toLowerCase();
                return f.name.toLowerCase().includes(search) ||
                       (f.city && f.city.toLowerCase().includes(search)) ||
                       (f.state && f.state.toLowerCase().includes(search));
            });
            
            if (filtered.length === 0 && friends.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üë•</div>
                        <div style="font-weight: 500; margin-bottom: 8px;">No friends yet</div>
                        <div style="font-size: 13px;">Import your contacts or add friends manually</div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = filtered.slice(0, 200).map(f => {
                const statusIcon = f.status === 'geocoded' ? 'üìç' : 
                                  f.status === 'pending' ? '‚è≥' : '‚ùå';
                return `
                    <div class="friend-card" onclick="focusOnFriend(${f.id})">
                        <div class="friend-info">
                            <div class="friend-name">${f.name}</div>
                            <div class="friend-location">${f.city || 'Unknown'}, ${f.state || ''}</div>
                        </div>
                        <span class="friend-status">${statusIcon}</span>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteFriend(${f.id})">√ó</button>
                    </div>
                `;
            }).join('');
            
            if (filtered.length > 200) {
                list.innerHTML += `<div style="text-align: center; padding: 16px; color: #65676b;">
                    ... and ${filtered.length - 200} more</div>`;
            }
        }
        
        function updateMap() {
            if (!map) return;
            
            // Clear existing markers
            markers.forEach(m => m.setMap(null));
            infoWindows.forEach(w => w.close());
            markers = [];
            infoWindows = [];
            
            const geocoded = friends.filter(f => f.lat && f.lng);
            
            geocoded.forEach(friend => {
                const marker = new google.maps.Marker({
                    position: { lat: friend.lat, lng: friend.lng },
                    map: map,
                    title: friend.name,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 4, // Small dot
                        fillColor: '#FF4444',
                        fillOpacity: 0.8,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 1.5
                    },
                    animation: google.maps.Animation.DROP
                });
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 12px; min-width: 200px;">
                            <h3 style="margin: 0 0 8px 0; font-size: 16px;">${friend.name}</h3>
                            <p style="margin: 0 0 4px 0; color: #666;">üìç ${friend.city}, ${friend.state}</p>
                            ${friend.phone ? `<p style="margin: 0 0 4px 0;">üìû ${friend.phone}</p>` : ''}
                            ${friend.email ? `<p style="margin: 0;">‚úâÔ∏è ${friend.email}</p>` : ''}
                        </div>
                    `
                });
                
                marker.addListener('click', () => {
                    infoWindows.forEach(w => w.close());
                    infoWindow.open(map, marker);
                });
                
                // Add hover effect for better visibility
                marker.addListener('mouseover', () => {
                    marker.setIcon({
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 6, // Slightly larger on hover
                        fillColor: '#FF0000',
                        fillOpacity: 1,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 2
                    });
                });
                
                marker.addListener('mouseout', () => {
                    marker.setIcon({
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 4, // Back to small
                        fillColor: '#FF4444',
                        fillOpacity: 0.8,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 1.5
                    });
                });
                
                markers.push(marker);
                infoWindows.push(infoWindow);
            });
            
            // Fit bounds
            if (geocoded.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                geocoded.forEach(f => bounds.extend({ lat: f.lat, lng: f.lng }));
                map.fitBounds(bounds);
                
                if (geocoded.length === 1) {
                    map.setZoom(12);
                }
            }
        }
        
        function focusOnFriend(id) {
            const friend = friends.find(f => f.id === id);
            if (friend && friend.lat && friend.lng && map) {
                map.setCenter({ lat: friend.lat, lng: friend.lng });
                map.setZoom(15);
                
                const index = friends.filter(f => f.lat && f.lng).findIndex(f => f.id === id);
                if (index >= 0 && infoWindows[index]) {
                    infoWindows.forEach(w => w.close());
                    infoWindows[index].open(map, markers[index]);
                }
            }
        }
        
        function deleteFriend(id) {
            if (confirm('Delete this friend?')) {
                friends = friends.filter(f => f.id !== id);
                updateDisplay();
                saveToStorage();
            }
        }
        
        // Retry failed geocoding
        function retryFailed() {
            const failed = friends.filter(f => f.status === 'failed' || f.status === 'pending');
            if (failed.length === 0) {
                showAlert('info', 'No failed geocoding to retry');
                return;
            }
            
            if (confirm(`Retry geocoding for ${failed.length} failed addresses?`)) {
                failed.forEach(f => f.status = 'pending');
                geocodeQueue = failed;
                processGeocodeQueue();
            }
        }
        
        // Update contacts (re-import)
        function updateContacts() {
            const message = `To update contacts:
1. Export current data (for backup)
2. Go to iCloud.com ‚Üí Contacts
3. Export fresh vCard file
4. Import the new file here

This will merge new contacts and update existing ones.`;
            
            alert(message);
            document.getElementById('fileInput').click();
        }
        
        // Clear all data
        function clearAllData() {
            if (confirm('‚ö†Ô∏è This will delete ALL friends from the map!\n\nAre you sure?')) {
                if (confirm('Really sure? This cannot be undone!\n\nTip: Export your data first as backup.')) {
                    friends = [];
                    geocodeQueue = [];
                    geocodeCount = 0;
                    searchTerm = '';
                    
                    localStorage.removeItem('friendMapData');
                    localStorage.removeItem('geocodeCount');
                    
                    updateDisplay();
                    showAlert('success', 'All data cleared. Import contacts to start fresh.');
                }
            }
        }
        
        // Enhanced export with timestamp
        function exportData() {
            const exportObj = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                totalFriends: friends.length,
                geocoded: friends.filter(f => f.status === 'geocoded').length,
                friends: friends
            };
            
            const data = JSON.stringify(exportObj, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `friend-map-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showAlert('success', `Exported ${friends.length} friends. Save this file for backup!`);
        }
        
        // Enhanced import with merge capability
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                
                if (file.name.endsWith('.json')) {
                    try {
                        const imported = JSON.parse(content);
                        const importedFriends = imported.friends || imported;
                        
                        if (friends.length > 0) {
                            // Merge mode
                            if (confirm(`You have ${friends.length} existing friends.\n\nMerge with imported data (Yes) or Replace all (No)?`)) {
                                // Merge: Add only new friends
                                const existingNames = new Set(friends.map(f => f.name.toLowerCase()));
                                const newFriends = importedFriends.filter(f => 
                                    !existingNames.has(f.name.toLowerCase())
                                );
                                friends = friends.concat(newFriends);
                                showAlert('success', `Merged ${newFriends.length} new friends`);
                            } else {
                                // Replace
                                friends = importedFriends;
                                showAlert('success', `Replaced with ${friends.length} friends from backup`);
                            }
                        } else {
                            friends = importedFriends;
                            showAlert('success', `Imported ${friends.length} friends from backup`);
                        }
                        
                        updateDisplay();
                        saveToStorage();
                        
                    } catch (err) {
                        showAlert('error', 'Invalid JSON file');
                    }
                } else if (content.includes('BEGIN:VCARD')) {
                    const contacts = parseVCard(content);
                    
                    if (contacts.length === 0) {
                        showAlert('warning', 'No contacts with addresses found');
                        return;
                    }
                    
                    console.log('Parsed', contacts.length, 'contacts from vCard');
                    
                    if (friends.length > 0) {
                        // Check for duplicates
                        const existingNames = new Set(friends.map(f => f.name.toLowerCase()));
                        const newContacts = contacts.filter(c => 
                            !existingNames.has(c.name.toLowerCase())
                        );
                        const duplicates = contacts.length - newContacts.length;
                        
                        if (duplicates > 0) {
                            showAlert('info', `Found ${newContacts.length} new contacts (${duplicates} duplicates skipped)`);
                        }
                        
                        friends = friends.concat(newContacts);
                        geocodeQueue = newContacts;
                    } else {
                        // Fresh import - make sure to set friends array
                        friends = contacts;
                        geocodeQueue = [...contacts]; // Create copy for geocoding
                        console.log('Set friends array with', friends.length, 'contacts');
                    }
                    
                    // Force immediate UI update
                    updateDisplay();
                    saveToStorage();
                    
                    showAlert('success', `Processing ${geocodeQueue.length} contacts...`);
                    
                    // Start geocoding after a small delay to ensure UI updates
                    setTimeout(() => {
                        processGeocodeQueue();
                    }, 100);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // Storage
        function saveToStorage() {
            try {
                localStorage.setItem('friendMapData', JSON.stringify(friends));
                localStorage.setItem('geocodeCount', geocodeCount.toString());
            } catch (e) {
                console.error('Save failed:', e);
            }
        }
        
        function loadFromStorage() {
            try {
                const data = localStorage.getItem('friendMapData');
                if (data) {
                    friends = JSON.parse(data);
                    
                    // Resume pending geocoding
                    const pending = friends.filter(f => f.status === 'pending');
                    if (pending.length > 0) {
                        geocodeQueue = pending;
                        showAlert('warning', `Found ${pending.length} pending geocodes. Click "Retry Failed" button or re-import to try again.`);
                        
                        // Add retry button
                        const retryBtn = document.createElement('button');
                        retryBtn.className = 'btn btn-warning';
                        retryBtn.style.width = '100%';
                        retryBtn.style.marginTop = '8px';
                        retryBtn.textContent = 'üîÑ Retry Failed Geocoding';
                        retryBtn.onclick = () => {
                            const failed = friends.filter(f => f.status === 'failed' || f.status === 'pending');
                            if (failed.length > 0) {
                                geocodeQueue = failed;
                                failed.forEach(f => f.status = 'pending');
                                processGeocodeQueue();
                            }
                        };
                        
                        const buttonGroup = document.querySelector('.button-group');
                        if (buttonGroup && !document.querySelector('.retry-btn')) {
                            retryBtn.className = 'btn btn-warning retry-btn';
                            buttonGroup.parentElement.insertBefore(retryBtn, buttonGroup.nextSibling);
                        }
                    }
                }
                
                const count = localStorage.getItem('geocodeCount');
                if (count) {
                    geocodeCount = parseInt(count);
                    document.getElementById('geocodeCount').textContent = geocodeCount;
                }
            } catch (e) {
                console.error('Load failed:', e);
            }
        }
        
        // Modal functions
        function showAddModal() {
            document.getElementById('addModal').style.display = 'flex';
        }
        
        function hideAddModal() {
            document.getElementById('addModal').style.display = 'none';
            document.getElementById('addForm').reset();
        }
        
        function addFriend(event) {
            event.preventDefault();
            
            const friend = {
                id: Date.now(),
                name: document.getElementById('inputName').value,
                address: document.getElementById('inputAddress').value,
                city: document.getElementById('inputCity').value,
                state: document.getElementById('inputState').value,
                zip: document.getElementById('inputZip').value,
                country: document.getElementById('inputCountry').value || 'USA',
                phone: document.getElementById('inputPhone').value,
                email: document.getElementById('inputEmail').value,
                status: 'pending'
            };
            
            friends.push(friend);
            geocodeQueue.push(friend);
            
            hideAddModal();
            updateDisplay();
            saveToStorage();
            processGeocodeQueue();
        }
        
        // Alert functions
        function showAlert(type, message) {
            const alerts = {
                error: document.getElementById('errorAlert'),
                warning: document.getElementById('warningAlert'),
                success: document.getElementById('successAlert')
            };
            
            Object.values(alerts).forEach(a => a.style.display = 'none');
            
            if (alerts[type]) {
                alerts[type].textContent = message;
                alerts[type].style.display = 'block';
                
                setTimeout(() => {
                    alerts[type].style.display = 'none';
                }, 5000);
            }
        }
        
        // Event listeners
        document.getElementById('searchBox').addEventListener('input', (e) => {
            searchTerm = e.target.value;
            updateFriendsList();
        });
        
        document.getElementById('addModal').addEventListener('click', (e) => {
            if (e.target.id === 'addModal') hideAddModal();
        });
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            updateDisplay();
        });
        
        // Load Google Maps
        const script = document.createElement('script');
        script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyCAHA2rJUh_pVQgH_N-AFc35UEfiR5jr70&callback=initMap';
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    </script>
</body>
</html>
