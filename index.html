<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friend Map</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üó∫Ô∏è</text></svg>">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script>
        const { useState, useEffect, useRef, createElement: h } = React;

        const FriendMap = () => {
          const [friends, setFriends] = useState([]);
          const [showAddForm, setShowAddForm] = useState(false);
          const [editingFriend, setEditingFriend] = useState(null);
          const [searchTerm, setSearchTerm] = useState('');
          const [selectedFriend, setSelectedFriend] = useState(null);
          const [showContactCard, setShowContactCard] = useState(false);
          const [newFriend, setNewFriend] = useState({
            name: '', address: '', city: '', state: '', zipCode: '', phone: '', email: '', photo: ''
          });
          const mapRef = useRef(null);
          const fileInputRef = useRef(null);
          const [map, setMap] = useState(null);
          const [markers, setMarkers] = useState([]);

          // Initialize Google Maps
          useEffect(() => {
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyCAHA2rJUh_pVQgH_N-AFc35UEfiR5jr70&libraries=geocoding';
            script.async = true;
            script.defer = true;
            script.onload = initMap;
            document.head.appendChild(script);
            return () => {
              if (document.head.contains(script)) {
                document.head.removeChild(script);
              }
            };
          }, []);

          const initMap = () => {
            if (mapRef.current && window.google) {
              const mapInstance = new window.google.maps.Map(mapRef.current, {
                zoom: 4,
                center: { lat: 39.8283, lng: -98.5795 },
                styles: [{ featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] }]
              });
              setMap(mapInstance);
            }
          };

          const geocodeAddress = async (address) => {
            return new Promise((resolve) => {
              if (!window.google || !window.google.maps) {
                resolve({ lat: 40.7128 + (Math.random() - 0.5) * 20, lng: -74.0060 + (Math.random() - 0.5) * 40 });
                return;
              }
              const geocoder = new window.google.maps.Geocoder();
              geocoder.geocode({ address }, (results, status) => {
                if (status === 'OK' && results[0]) {
                  const location = results[0].geometry.location;
                  resolve({ lat: location.lat(), lng: location.lng() });
                } else {
                  resolve({ lat: 39.8283 + (Math.random() - 0.5) * 10, lng: -98.5795 + (Math.random() - 0.5) * 20 });
                }
              });
            });
          };

          const parseVCard = (vcardText) => {
            const contacts = [];
            const vcards = vcardText.split('BEGIN:VCARD');
            vcards.forEach((vcard, index) => {
              if (index === 0) return;
              const lines = vcard.split('\n').map(line => line.trim()).filter(line => line);
              const contact = { id: Date.now() + index };
              lines.forEach(line => {
                if (line.startsWith('FN:')) {
                  contact.name = line.substring(3).trim();
                } else if (line.startsWith('N:') && !contact.name) {
                  const nameParts = line.substring(2).split(';');
                  contact.name = ((nameParts[1] || '') + ' ' + (nameParts[0] || '')).trim();
                } else if (line.startsWith('TEL')) {
                  const phoneMatch = line.match(/TEL[^:]*:(.*)/);
                  if (phoneMatch && !contact.phone) contact.phone = phoneMatch[1].trim();
                } else if (line.startsWith('EMAIL')) {
                  const emailMatch = line.match(/EMAIL[^:]*:(.*)/);
                  if (emailMatch && !contact.email) contact.email = emailMatch[1].trim();
                } else if (line.startsWith('ADR')) {
                  const addrMatch = line.match(/ADR[^:]*:(.*)/);
                  if (addrMatch) {
                    const addrParts = addrMatch[1].split(';');
                    contact.address = addrParts[2] || '';
                    contact.city = addrParts[3] || '';
                    contact.state = addrParts[4] || '';
                    contact.zipCode = addrParts[5] || '';
                  }
                }
              });
              if (contact.name && (contact.address || contact.city)) {
                contacts.push(contact);
              }
            });
            return contacts;
          };

          const handleFileUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
              const content = e.target.result;
              let newFriends = [];
              if (file.name.toLowerCase().endsWith('.vcf') || content.includes('BEGIN:VCARD')) {
                const vcardContacts = parseVCard(content);
                for (const contact of vcardContacts) {
                  if (contact.name && (contact.address || contact.city)) {
                    const fullAddress = contact.address ? 
                      contact.address + ', ' + contact.city + ', ' + contact.state + ' ' + contact.zipCode :
                      contact.city + ', ' + contact.state + ' ' + contact.zipCode;
                    try {
                      const coords = await geocodeAddress(fullAddress.trim());
                      newFriends.push({ ...contact, lat: coords.lat, lng: coords.lng });
                    } catch (error) {
                      console.error('Error geocoding address for:', contact.name);
                    }
                  }
                }
              }
              if (newFriends.length > 0) {
                setFriends([...friends, ...newFriends]);
                alert('Successfully imported ' + newFriends.length + ' contacts with addresses!');
              } else {
                alert('No contacts with addresses found in the file.');
              }
            };
            reader.readAsText(file);
          };

          useEffect(() => {
            if (map && friends.length > 0) {
              markers.forEach(marker => marker.setMap(null));
              const newMarkers = friends.map(friend => {
                if (!friend.lat || !friend.lng || !window.google) return null;
                const marker = new window.google.maps.Marker({
                  position: { lat: friend.lat, lng: friend.lng },
                  map: map,
                  title: friend.name,
                  icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#EF4444"><path d="M12 0C7.802 0 4.4 3.403 4.4 7.602 4.4 11.8 12 24 12 24s7.6-12.2 7.6-16.398C19.6 3.403 16.197 0 12 0zM12 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/></svg>'),
                    scaledSize: new window.google.maps.Size(32, 32)
                  }
                });
                marker.addListener('click', () => {
                  setSelectedFriend(friend);
                  setShowContactCard(true);
                });
                return marker;
              }).filter(Boolean);
              setMarkers(newMarkers);
              if (newMarkers.length > 0) {
                const bounds = new window.google.maps.LatLngBounds();
                friends.forEach(friend => {
                  if (friend.lat && friend.lng) bounds.extend({ lat: friend.lat, lng: friend.lng });
                });
                map.fitBounds(bounds);
              }
            }
          }, [map, friends]);

          const handleAddFriend = async () => {
            if (!newFriend.name || !newFriend.city || !newFriend.state) {
              alert('Please fill in name, city, and state');
              return;
            }
            const fullAddress = newFriend.address + ', ' + newFriend.city + ', ' + newFriend.state + ' ' + newFriend.zipCode;
            const coords = await geocodeAddress(fullAddress);
            const friendWithCoords = { ...newFriend, id: Date.now(), lat: coords.lat, lng: coords.lng };
            if (editingFriend) {
              setFriends(friends.map(f => f.id === editingFriend.id ? friendWithCoords : f));
              setEditingFriend(null);
            } else {
              setFriends([...friends, friendWithCoords]);
            }
            setNewFriend({ name: '', address: '', city: '', state: '', zipCode: '', phone: '', email: '', photo: '' });
            setShowAddForm(false);
          };

          const handleEditFriend = (friend) => {
            setNewFriend(friend);
            setEditingFriend(friend);
            setShowAddForm(true);
            setShowContactCard(false);
          };

          const handleDeleteFriend = (id) => setFriends(friends.filter(f => f.id !== id));

          const filteredFriends = friends.filter(friend =>
            friend.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            friend.city.toLowerCase().includes(searchTerm.toLowerCase()) ||
            friend.state.toLowerCase().includes(searchTerm.toLowerCase())
          );

          // Create helper components with React.createElement
          const MapIcon = h('svg', { className: 'h-8 w-8 text-red-500', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor' },
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z' }),
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 11a3 3 0 11-6 0 3 3 0 016 0z' })
          );

          const UsersIcon = h('svg', { className: 'h-5 w-5 mr-2', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor' },
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z' })
          );

          return h('div', { className: 'min-h-screen bg-gray-50' },
            // Header
            h('div', { className: 'bg-white shadow-sm border-b' },
              h('div', { className: 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8' },
                h('div', { className: 'flex items-center justify-between h-16' },
                  h('div', { className: 'flex items-center space-x-3' },
                    MapIcon,
                    h('h1', { className: 'text-2xl font-bold text-gray-900' }, 'Friend Map')
                  ),
                  h('div', { className: 'flex items-center space-x-4' },
                    h('span', { className: 'flex items-center text-gray-600' },
                      UsersIcon,
                      friends.length + ' friends'
                    )
                  )
                )
              )
            ),
            // Main content
            h('div', { className: 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8' },
              h('div', { className: 'grid grid-cols-1 lg:grid-cols-3 gap-8' },
                // Sidebar
                h('div', { className: 'lg:col-span-1' },
                  h('div', { className: 'bg-white rounded-lg shadow p-6' },
                    h('div', { className: 'flex items-center justify-between mb-6' },
                      h('h2', { className: 'text-lg font-semibold text-gray-900' }, 'Your Friends'),
                      h('div', { className: 'flex space-x-2' },
                        h('button', {
                          onClick: () => setShowAddForm(true),
                          className: 'bg-blue-600 text-white px-3 py-2 rounded-md text-sm hover:bg-blue-700 flex items-center'
                        }, '+ Add'),
                        h('button', {
                          onClick: () => fileInputRef.current.click(),
                          className: 'bg-green-600 text-white px-3 py-2 rounded-md text-sm hover:bg-green-700 flex items-center'
                        }, '‚Üë Import')
                      )
                    ),
                    h('input', {
                      type: 'file',
                      ref: fileInputRef,
                      onChange: handleFileUpload,
                      accept: '.vcf',
                      className: 'hidden'
                    }),
                    // Search
                    h('div', { className: 'mb-4' },
                      h('input', {
                        type: 'text',
                        placeholder: 'Search friends...',
                        value: searchTerm,
                        onChange: (e) => setSearchTerm(e.target.value),
                        className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500'
                      })
                    ),
                    // Friends list
                    h('div', { className: 'space-y-3 max-h-96 overflow-y-auto' },
                      filteredFriends.length === 0 ? 
                        h('div', { className: 'text-center py-8 text-gray-500' },
                          h('p', null, 'No friends added yet.'),
                          h('p', { className: 'text-sm' }, 'Add your first friend to get started!')
                        ) :
                        filteredFriends.map((friend) => 
                          h('div', { key: friend.id, className: 'flex items-center justify-between p-3 bg-gray-50 rounded-md' },
                            h('div', { className: 'flex-1' },
                              h('h3', { className: 'font-medium text-gray-900' }, friend.name),
                              h('p', { className: 'text-sm text-gray-600' }, friend.city + ', ' + friend.state)
                            ),
                            h('div', { className: 'flex space-x-1' },
                              h('button', {
                                onClick: () => handleEditFriend(friend),
                                className: 'p-1 text-gray-400 hover:text-blue-600'
                              }, '‚úèÔ∏è'),
                              h('button', {
                                onClick: () => handleDeleteFriend(friend.id),
                                className: 'p-1 text-gray-400 hover:text-red-600'
                              }, 'üóëÔ∏è')
                            )
                          )
                        )
                    ),
                    // Import instructions
                    h('div', { className: 'mt-6 p-4 bg-blue-50 rounded-md' },
                      h('h4', { className: 'text-sm font-medium text-blue-900 mb-3' }, 'üì± Import Apple Contacts'),
                      h('div', { className: 'space-y-2 text-xs text-blue-700' },
                        h('div', null, '1. Go to icloud.com ‚Üí Sign in'),
                        h('div', null, '2. Click "Contacts" ‚Üí Select All'),
                        h('div', null, '3. Export vCard ‚Üí Upload here'),
                        h('div', { className: 'mt-2 p-2 bg-amber-50 rounded text-amber-700' },
                          'üí° Only contacts with addresses will appear on the map'
                        )
                      )
                    )
                  )
                ),
                // Map
                h('div', { className: 'lg:col-span-2' },
                  h('div', { className: 'bg-white rounded-lg shadow overflow-hidden' },
                    h('div', {
                      ref: mapRef,
                      className: 'w-full h-96 lg:h-[600px]',
                      style: { background: '#f3f4f6' }
                    },
                      !window.google && h('div', { className: 'w-full h-full flex items-center justify-center text-gray-500' },
                        h('div', { className: 'text-center' },
                          h('p', null, 'Loading Google Maps...'),
                          h('p', { className: 'text-xs mt-2' }, 'Using your active API key')
                        )
                      )
                    )
                  )
                )
              )
            ),
            // Add Friend Modal
            showAddForm && h('div', { className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50' },
              h('div', { className: 'bg-white rounded-lg p-6 w-full max-w-md' },
                h('h3', { className: 'text-lg font-semibold mb-4' }, editingFriend ? 'Edit Friend' : 'Add New Friend'),
                h('div', { className: 'space-y-4' },
                  h('input', {
                    type: 'text',
                    placeholder: 'Name',
                    value: newFriend.name,
                    onChange: (e) => setNewFriend({...newFriend, name: e.target.value}),
                    className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500'
                  }),
                  h('input', {
                    type: 'text',
                    placeholder: 'Street Address',
                    value: newFriend.address,
                    onChange: (e) => setNewFriend({...newFriend, address: e.target.value}),
                    className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500'
                  }),
                  h('div', { className: 'grid grid-cols-2 gap-4' },
                    h('input', {
                      type: 'text',
                      placeholder: 'City',
                      value: newFriend.city,
                      onChange: (e) => setNewFriend({...newFriend, city: e.target.value}),
                      className: 'px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500'
                    }),
                    h('input', {
                      type: 'text',
                      placeholder: 'State',
                      value: newFriend.state,
                      onChange: (e) => setNewFriend({...newFriend, state: e.target.value}),
                      className: 'px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500'
                    })
                  ),
                  h('input', {
                    type: 'text',
                    placeholder: 'ZIP Code',
                    value: newFriend.zipCode,
                    onChange: (e) => setNewFriend({...newFriend, zipCode: e.target.value}),
                    className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500'
                  }),
                  h('input', {
                    type: 'text',
                    placeholder: 'Phone (optional)',
                    value: newFriend.phone,
                    onChange: (e) => setNewFriend({...newFriend, phone: e.target.value}),
                    className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500'
                  }),
                  h('input', {
                    type: 'email',
                    placeholder: 'Email (optional)',
                    value: newFriend.email,
                    onChange: (e) => setNewFriend({...newFriend, email: e.target.value}),
                    className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500'
                  }),
                  h('div', { className: 'flex space-x-4' },
                    h('button', {
                      onClick: handleAddFriend,
                      className: 'flex-1 bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700'
                    }, editingFriend ? 'Update Friend' : 'Add Friend'),
                    h('button', {
                      onClick: () => {
                        setShowAddForm(false);
                        setEditingFriend(null);
                        setNewFriend({ name: '', address: '', city: '', state: '', zipCode: '', phone: '', email: '', photo: '' });
                      },
                      className: 'flex-1 bg-gray-300 text-gray-700 py-2 rounded-md hover:bg-gray-400'
                    }, 'Cancel')
                  )
                )
              )
            ),
            // Contact Card Modal
            showContactCard && selectedFriend && h('div', { className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50' },
              h('div', { className: 'bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm relative' },
                h('button', {
                  onClick: () => setShowContactCard(false),
                  className: 'absolute top-4 right-4 text-gray-400 hover:text-gray-600'
                }, '‚úï'),
                h('div', { className: 'text-center mb-6' },
                  h('div', { className: 'w-20 h-20 rounded-full mx-auto mb-4 bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white text-2xl font-bold' },
                    selectedFriend.name.split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase()
                  ),
                  h('h3', { className: 'text-xl font-bold text-gray-900 mb-2' }, selectedFriend.name)
                ),
                h('div', { className: 'space-y-4' },
                  selectedFriend.phone && h('div', { className: 'flex items-center space-x-3' },
                    h('div', { className: 'w-10 h-10 bg-green-100 rounded-full flex items-center justify-center' }, 'üìû'),
                    h('div', null,
                      h('p', { className: 'text-sm text-gray-500' }, 'Phone'),
                      h('p', { className: 'text-gray-900 font-medium' }, selectedFriend.phone)
                    )
                  ),
                  selectedFriend.email && h('div', { className: 'flex items-center space-x-3' },
                    h('div', { className: 'w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center' }, '‚úâÔ∏è'),
                    h('div', null,
                      h('p', { className: 'text-sm text-gray-500' }, 'Email'),
                      h('p', { className: 'text-gray-900 font-medium' }, selectedFriend.email)
                    )
                  ),
                  h('div', { className: 'flex items-center space-x-3' },
                    h('div', { className: 'w-10 h-10 bg-red-100 rounded-full flex items-center justify-center' }, 'üìç'),
                    h('div', null,
                      h('p', { className: 'text-sm text-gray-500' }, 'Address'),
                      h('p', { className: 'text-gray-900 font-medium' },
                        (selectedFriend.address ? selectedFriend.address + ', ' : '') +
                        selectedFriend.city + ', ' + selectedFriend.state + ' ' + selectedFriend.zipCode
                      )
                    )
                  )
                ),
                h('div', { className: 'mt-6 flex flex-wrap gap-2' },
                  selectedFriend.phone && h('a', {
                    href: 'tel:' + selectedFriend.phone,
                    className: 'bg-green-600 text-white py-2 px-4 rounded-lg text-center text-sm font-medium hover:bg-green-700 transition-colors'
                  }, 'Call'),
                  selectedFriend.email && h('a', {
                    href: 'mailto:' + selectedFriend.email,
                    className: 'bg-blue-600 text-white py-2 px-4 rounded-lg text-center text-sm font-medium hover:bg-blue-700 transition-colors'
                  }, 'Email'),
                  h('button', {
                    onClick: () => handleEditFriend(selectedFriend),
                    className: 'bg-gray-600 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-gray-700 transition-colors'
                  }, 'Edit')
                )
              )
            )
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(FriendMap));
    </script>
</body>
</html>
